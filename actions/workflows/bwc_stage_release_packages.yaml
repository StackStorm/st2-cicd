version: '2.0'

st2cd.bwc_stage_release_packages:
    description: Stage bwc packages for release.
    type: direct
    input:
        - version
        - projects
        - username: stackstorm
        - wait
        - distros:
            RHEL6: el6
            RHEL7: el7
            UBUNTU14: u14
            UBUNTU16: u16
            UBUNTU18: u18
    tasks:
        init:
            action: core.local
            input:
                cmd: "echo <% $.version %> | cut -d \".\" -f1-2"
            publish:
                branch: v<% task(init).result.stdout %>
            on-success:
                - package_all
        package_all:
            with-items: project in <% $.projects %>
            action: circle_ci.run_build
            input:
                project: <% $.project %>
                username: <% $.username %>
                branch: <% $.branch %>
            publish:
                package_jobs: <% task(package_all).result.select(
                                [$.result.reponame, $.result.build_num]) %>
            on-success:
                - wait_for_packages: <% $.wait %>
        wait_for_packages:
            with-items: package_job in <% $.package_jobs %>
            action: st2cd.wait_for_package
            input:
                project: <% $.package_job[0] %>
                username: <% $.username %>
                build_number: <% str($.package_job[1]) %>
