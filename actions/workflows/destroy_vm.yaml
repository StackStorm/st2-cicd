version: '2.0'

st2cd.destroy_vm:
    description: Destroy VM and associated resources
    type: direct
    input:
        - hostname
        - dns_zone

    task-defaults:
        on-error:
            - notify_failure

    tasks:
        get_instance_dns:
            action: linux.dig
            input:
                hostname: <% $.hostname %>.<% $.dns_zone %>
                count: 1
            on-success:
                - get_instances
        get_instances:
            action: aws.ec2_get_only_instances
            publish:
                instances: <%
                        task(get_instances).result.result.where(
                            $.private_dns_name + '.' = task(get_instance_dns).result.result[0] or
                            $.private_ip_address = task(get_instance_dns).result.result[0]
                        ).select($.id)
                    %>
            on-success:
                - destroy_instance: <% len($.instances) = 1 %>
                - fail: <% len($.instances) > 1 %>
                - noop: <% len($.instances) < 1 %>

        destroy_instance:
            action: aws.ec2_terminate_instances
            input:
                instance_ids: <% $.instances[0] %>
            on-success:
                - delete_cname
        delete_cname:
            action: aws.r53_zone_delete_cname
            input:
                zone: <% $.dns_zone %>
                name: <% $.hostname %>.<% $.dns_zone %> 
            on-success:
                - notify_success

        notify_success:
            action: slack.post_message
            input:
                channel: "#opstown"
                message: "[SUCCESS] <% $.hostname %> was destroyed"

        notify_failure:
            action: slack.post_message
            input:
                channel: "#opstown"
                message: "[FAILED] <% $.hostname %> was not destroyed"
            on-complete:
                - fail
