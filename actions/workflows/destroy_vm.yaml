---
version: '1.0'
description: Destroy VM and associated resources
input:
  - hostname
  - dns_zone
  - instance_id
  - used_dns: false
  - used_id: false
vars:
  - volume_to_delete_iteration_count: 0
tasks:
  get_instance_dns:
    action: linux.dig
    input:
      hostname: <% ctx().hostname %>.<% ctx().dns_zone %>
      count: 1
    next:
      - when: <% succeeded() and (len(result().result) > 0) %>
        do:
          - get_instances_by_dns
      - when: <% succeeded() and (len(result().result) <= 0 and ctx().instance_id != null) %>
        do:
          - get_instances_by_id
      - when: <% succeeded() and (len(result().result) <= 0 and ctx().instance_id = null) %>
        do:
          - noop
  get_instances_by_dns:
    action: aws.ec2_get_only_instances
    next:
      - when: <% succeeded() %>
        publish:
          - used_dns: true
          - instances: <% result().result.where($.private_dns_name + '.' = result().result[0] or $.private_ip_address = result().result[0]).select($.id) %>
      - when: <% succeeded() and (len(ctx().instances) = 1) %>
        do:
          - get_volumes
      - when: <% succeeded() and (len(ctx().instances) > 1 and ctx().instance_id = null) %>
        do:
          - notify_multiple_instances_failure
      - when: <% succeeded() and (len(ctx().instances) < 1 and ctx().instance_id = null) %>
        do:
          - noop
      - when: <% succeeded() and (len(ctx().instances) != 1 and ctx().instance_id != null) %>
        do:
          - get_instances_by_id
  get_instances_by_id:
    action: aws.ec2_get_only_instances
    next:
      - when: <% succeeded() %>
        publish:
          - used_dns: false
          - used_id: true
          - instances: <% result().result.where($.id = ctx().instance_id).select($.id) %>
      - when: <% succeeded() and (len(ctx().instances) = 1) %>
        do:
          - get_volumes
      - when: <% succeeded() and (len(ctx().instances) > 1) %>
        do:
          - notify_multiple_instances_failure
      - when: <% succeeded() and (len(ctx().instances) < 1) %>
        do:
          - noop
  get_volumes:
    action: aws.ec2_get_instance_attribute
    input:
      attribute: blockDeviceMapping
      instance_id: <% ctx().instances[0] %>
    next:
      - when: <% succeeded() %>
        publish:
          - volumes: <% result().result.first().get( blockDeviceMapping, {}).values().where( not $.get(delete_on_termination, True)).select($.volume_id) %>
        do:
          - destroy_instance
      - when: <% failed() %>
        do:
          - notify_destroy_instance_failure
  destroy_instance:
    action: aws.ec2_terminate_instances
    input:
      instance_ids: <% ctx().instances[0] %>
    next:
      - when: <% succeeded() %>
        do:
          - wait_for_instance_to_terminate
      - when: <% failed() %>
        do:
          - notify_destroy_instance_failure
  wait_for_instance_to_terminate:
    action: core.local
    input:
      cmd: sleep 60
      timeout: 120
    next:
      - when: <% succeeded() %>
        do:
          - delete_cname
  delete_cname:
    action: aws.r53_zone_delete_cname
    input:
      zone: <% ctx().dns_zone %>
      name: <% ctx().hostname %>.<% ctx().dns_zone %>
    next:
      - when: <% failed() %>
        do:
          - notify_delete_cname_failure
      - do:
          - delete_volumes
  delete_volumes:
    with:
      items: volume in <% ctx().volumes %>
    action: aws.ec2_delete_volume
    input:
      volume_id: <% item(volume) %>
    next:
      - when: <% succeeded() %>
        do:
          - notify_success
      - when: <% failed() %>
        publish:
          - volume_to_delete_iteration_count: <% ctx().volume_to_delete_iteration_count + 1 %>
      - when: <% failed() and (ctx().volume_to_delete_iteration_count >= 10) %>
        do:
          - notify_delete_volumes_failure
      - when: <% failed() and (ctx().volume_to_delete_iteration_count < 10) %>
        do:
          - wait_for_volume_to_delete
  wait_for_volume_to_delete:
    action: core.local
    input:
      cmd: sleep 60
    next:
      - when: <% succeeded() %>
        do:
          - delete_volumes
  notify_success:
    action: slack.post_message
    input:
      channel: '#thunderdome'
      message: '[SUCCEEDED] <% ctx().hostname %> was destroyed'
  notify_multiple_instances_failure:
    action: slack.post_message
    input:
      channel: '#opstown'
      message: '[FAILED] More than one instance for <% ctx().hostname %> were identified'
    next:
      - do:
          - fail
  notify_destroy_instance_failure:
    action: slack.post_message
    input:
      channel: '#opstown'
      message: '[FAILED] <% ctx().hostname %> was not destroyed'
    next:
      - do:
          - fail
  notify_delete_cname_failure:
    action: slack.post_message
    input:
      channel: '#opstown'
      message: '[FAILED] <% ctx().hostname %> was destroyed but CNAME was not deleted'
  notify_delete_volumes_failure:
    action: slack.post_message
    input:
      channel: '#opstown'
      message: '[FAILED] <% ctx().hostname %> was destroyed but volumes were not deleted'
    next:
      - do:
          - fail
