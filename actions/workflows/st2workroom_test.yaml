---
  vars:
    root_dir: "/opt/puppet"
    st2_username: "cibuild"
    st2_password: "cibuild"
  chain:
    -
      name: "create_vm_role"
      ref: "st2cd.create_vm_role"
      params:
        hostname: "{{hostname}}"
        instance_type: "{{instance_type}}"
        environment: "{{environment}}"
        key_name: "{{key_name}}"
        keyfile: "{{keyfile}}"
        distro: "{{distro}}"
        role: "{{role}}"
      publish:
        distro: "{{distro}}"
      on-success: "delete_existing_puppet"
    -
      name: "delete_existing_puppet"
      ref: "linux.rm"
      params:
        hosts: "{{hostname}}"
        target: "{{root_dir}}"
        force: true
        recursive: true
        sudo: true
      on-success: "write_answers_file"
    -
      name: "write_answers_file"
      ref: "core.remote_sudo"
      params:
        hosts: "{{hostname}}"
        cmd: |
            cat <<EOT >> /tmp/answers.yaml
            st2::version: {{version}}
            st2::revision: {{build}}
            st2::repo_base: {{dl_server}}
            EOT
      on-success: "bootstrap_workroom_with_answers_file"
      on-failure: "destroy_vm"
    -
      name: "bootstrap_workroom_with_answers_file"
      ref: "core.remote_sudo"
      params:
        env:
          ENV: "{{branch}}"
          SKIP_OK_CHECK: "true"
          DISABLE_HUBOT: "true"
          CI: "true"
        hosts: "{{hostname}}"
        cmd: "curl -sSL {{install_url}}  | sudo sh -s -- -a /tmp/answers.yaml"
        timeout: 3600
      on-success: "add_ci_user"
      on-failure: "rerun_bootstrap_workroom_with_answers_file"
    -
      name: "rerun_bootstrap_workroom_with_answers_file"
      ref: "core.remote_sudo"
      params:
        env:
          ENV: "{{branch}}"
          SKIP_OK_CHECK: "true"
          DISABLE_HUBOT: "true"
          CI: "true"
        hosts: "{{hostname}}"
        cmd: "curl -sSL {{install_url}}  | sudo sh -s -- -a /tmp/answers.yaml"
        timeout: 3600
      on-success: "add_ci_user"
    -
      name: "add_ci_user"
      ref: "st2cd.add_ci_user"
      params:
        hosts: "{{hostname}}"
        distro: "{{distro}}"
        user: "{{st2_username}}"
        pass: "{{st2_password}}"
      on-success: "verify_no_default_private_ssh_key_is_installed_for_stanley_1"
    -
      name: "verify_no_default_private_ssh_key_is_installed_for_stanley_1"
      ref: "core.remote_sudo"
      params:
        hosts: "{{hostname}}"
        cmd: 'test -f /home/stanley/.ssh/st2_stanley_key && (echo "Private SSH key file exists for stanley user" ; exit 1)'
      on-success: "verify_no_default_private_ssh_key_is_installed_for_stanley_2"
    -
      name: "verify_no_default_private_ssh_key_is_installed_for_stanley_2"
      ref: "core.remote_sudo"
      params:
        hosts: "{{hostname}}"
        cmd: 'files=$(find /home/stanley/.ssh/ -type f ! -name authorized_keys | wc -l) ; if [ $files -gt 0 ]; then echo "Found SSH key files"; exit 1; fi'
      on-success: "verify_no_default_authorized_key_is_installed_for_instaley"
    -
      name: "verify_no_default_authorized_key_is_installed_for_instaley"
      ref: "core.remote_sudo"
      params:
        hosts: "{{hostname}}"
        cmd: 'lines=$(cat /home/stanley/.ssh/authorized_keys | grep st2_stanley_key | wc -l) ; if [ $lines -gt 0 ]; then echo "Found default stanley in authorized_keys"; exit 1; fi'
      on-success: "run_tests"
    # TODO: Also add a test case for scenario where  st2::stanley::ssh_private_key, etc is provided
    -
      name: "run_tests"
      ref: "st2cd.e2e_tests"
      params:
        hostname: "{{hostname}}"
        build: "{{build}}"
        st2_username: "{{st2_username}}"
        st2_password: "{{st2_password}}"
        protocol: "https"
      on-success: "destroy_vm"
      on-failure: "restart_st2"
    -
      name: "restart_st2"
      ref: "core.remote_sudo"
      params:
        hosts: "{{hostname}}"
        cmd: "st2ctl restart && sleep 20"
        timeout: 180
      on-success: "rerun_tests"
    -
      name: "rerun_tests"
      ref: "st2cd.e2e_tests"
      params:
        hostname: "{{hostname}}"
        build: "{{build}}"
        st2_username: "{{st2_username}}"
        st2_password: "{{st2_password}}"
        protocol: "https"
      on-success: "destroy_vm"
    -
      name: "destroy_vm"
      ref: "st2cd.destroy_vm"
      params:
        hostname: "{{hostname}}"
  default: "create_vm_role"
