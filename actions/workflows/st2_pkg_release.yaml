version: '2.0'
st2cd.st2_pkg_release:
    description: Package and test st2 for release.
    input:
        - version
        - projects:
            - st2
            - st2flow
            - st2-packages
            - st2-enterprise-auth-backend-ldap
        - distros:
            - RHEL6
            - RHEL7
            - UBUNTU14
    tasks:
        init:
            action: core.local
            input:
                cmd: "echo <% $.version %> | cut -d \".\" -f1-2"
            publish:
                branch: v<% task(init).result.stdout %>
            on-success:
                - package_all
        package_all:
            with-items: project in <% $.projects %>
            action: circle_ci.run_build
            input:
                project: stackstorm/<% $.project %>
                branch: <% $.branch %>
            publish:
                package_jobs: <% task(package_all).result.select(
                                [$.result.reponame, $.result.build_num]) %>
            on-success:
                - wait_for_packages
        wait_for_packages:
            with-items: package_job in <% $.package_jobs %>
            action: circle_ci.wait_until_build_finishes
            input:
                project: stackstorm/<% $.package_job[0] %>
                build_number: <% $.package_job[1] %>
                wait_timeout: 1800
            on-success:
                - promote_all
        promote_all:
            with-items: distro in <% $.distros %>
            action: st2ci.st2_pkg_test_and_promote
            input:
                distro: <% $.distro %>
                release: stable
