---
version: '2.0'

st2cd.st2_e2e_tests_test_quickstart:
    type: direct
    input:
        - host
        - env
        - protocol
    tasks:
        init:
            action: std.noop
            publish:
                st2_cli_args: token=<% $.env.get(ST2_AUTH_TOKEN) %> protocol=<% $.protocol %>
            on-success:
                # Running 4 tasks at a time in parallel
                - test_quickstart
                - test_quickstart_key
                - test_quickstart_rules
                - test_quickstart_packs
        test_quickstart:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart <% $.st2_cli_args %>
                timeout: 180
            # on-success:
            #     - test_quickstart_key
        test_quickstart_key:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_key <% $.st2_cli_args %>
            # on-success:
            #     - test_quickstart_rules
        test_quickstart_rules:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_rules <% $.st2_cli_args %>
                timeout: 600
            # on-success:
            #     - test_quickstart_packs
        test_quickstart_packs:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_packs_pack <% $.st2_cli_args %>
                timeout: 600
            on-success:
                - test_quickstart_local_script
                - test_quickstart_remote_script
                - test_quickstart_passive_sensor
                - test_quickstart_polling_sensor
        test_quickstart_local_script:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_local_script_actions <% $.st2_cli_args %>
                timeout: 600
            # on-success:
            #     - test_quickstart_remote_script
        test_quickstart_remote_script:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_remote_script_actions <% $.st2_cli_args %>
                timeout: 600
            # on-success:
            #     - test_quickstart_passive_sensor
        test_quickstart_passive_sensor:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_passive_sensor <% $.st2_cli_args %>
                timeout: 600
            # on-success:
            #     - test_quickstart_polling_sensor
        test_quickstart_polling_sensor:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_polling_sensor <% $.st2_cli_args %>
                timeout: 600
            on-success:
                - test_quickstart_python
                - test_quickstart_trace
                - test_quickstart_run_pack_tests_tool
        test_quickstart_python:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_python_actions <% $.st2_cli_args %>
                timeout: 600
            # on-success:
            #     - test_quickstart_key_triggers
        test_quickstart_trace:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_quickstart_trace <% $.st2_cli_args %>
                timeout: 600
            # on-success:
            #     - test_quickstart_run_pack_tests_tool
        test_quickstart_run_pack_tests_tool:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                # Note: This test is only available and working in StackStorm >= 2.3dev
                cmd: "st2 action get tests.test_run_pack_tests_tool ; if [ $? -eq 0 ]; then st2 run tests.test_run_pack_tests_tool <% $.st2_cli_args %>; else echo 'run_pack_tests_tool tests not available'; fi"
                timeout: 600
            on-success:
                - test_quickstart_pack_install_tool
        test_quickstart_pack_install_tool:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                # Note: This test is only available and working in StackStorm >= 2.3dev
                cmd: "st2 action get tests.test_pack_install_tool ; if [ $? -eq 0 ]; then st2 run tests.test_pack_install_tool <% $.st2_cli_args %>; else echo 'pack_install_tool tests not available'; fi"
                timeout: 600
            # Keep key_triggers and timer_rules tests sequential.
            # test_quickstart_key_triggers conflicts with test_quickstart_python (race) so
            # they can't run at the same time.
            on-success:
                - test_quickstart_key_triggers
        test_quickstart_key_triggers:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_key_triggers <% $.st2_cli_args %>
                timeout: 600
            on-success:
                - test_quickstart_timer_rules
        test_quickstart_timer_rules:
            action: core.remote
            input:
                hosts: <% $.host %>
                env: <% $.env %>
                cmd: st2 run tests.test_timer_rule <% $.st2_cli_args %>
                timeout: 600
