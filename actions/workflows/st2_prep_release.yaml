---
version: '1.0'
description: Prepare st2 for release.
input:
  - version
  - fork
  - host
  - cwd
  - local_repo_sfx:
tasks:
  init:
    action: core.local
    input:
      cmd: echo `date +'%s'`_`awk -v min=100 -v max=999 'BEGIN{srand(); print int(min+rand()*(max-min+1))}'`
    next:
      - when: <% succeeded() and (ctx().host = null) %>
        publish:
          - local_repo_sfx: <% result().stdout %>
        do:
          - get_host
      - when: <% succeeded() and (ctx().host != null) %>
        publish:
          - local_repo_sfx: <% result().stdout %>
        do:
          - prep
  get_host:
    action: linux.dig
    input:
      hostname: st2-build-slave-ubuntu.service.consul
      rand: true
      count: 1
    next:
      - when: <% succeeded() %>
        publish:
          - host: <% result().result[0] %>
        do:
          - prep
  prep:
    next:
      - do:
          - prep_st2
  prep_st2:
    action: st2cd.st2_prep_release_for_st2
    input:
      project: st2
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2docs
  prep_st2docs:
    action: st2cd.st2_prep_release_for_st2docs
    input:
      project: st2docs
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2docs_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2tests
  prep_st2tests:
    action: st2cd.st2_prep_release_for_st2tests
    input:
      project: st2tests
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2tests_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2web
  prep_st2web:
    action: st2cd.st2_prep_release_for_gui
    input:
      project: st2web
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2web_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2chatops
  prep_st2chatops:
    action: st2cd.st2_prep_release_for_gui
    input:
      project: st2chatops
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2chatops_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2flow
  prep_st2flow:
    action: st2cd.st2_prep_release_for_gui
    input:
      project: st2flow
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2flow_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2_pkg
  prep_st2_pkg:
    action: st2cd.st2_prep_release_for_st2_pkg
    input:
      project: st2-packages
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2_packages_' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2_dockerfiles
  prep_st2_dockerfiles:
    action: st2cd.st2_prep_release_for_st2_dockerfiles
    input:
      project: st2-dockerfiles
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2_dockerfiles_' + ctx().local_repo_sfx %>
      branch: v<% ctx().version.substring(0, ctx().version.lastIndexOf('.')) %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
    next:
      - when: <% succeeded() %>
        do:
          - prep_st2enterprise_dockerfiles
  prep_st2enterprise_dockerfiles:
    action: st2cd.st2_prep_release_for_st2enterprise_dockerfiles
    input:
      project: st2enterprise-dockerfiles
      version: <% ctx().version %>
      fork: <% ctx().fork %>
      local_repo: <% 'st2enterprise_dockerfiles_' + ctx().local_repo_sfx %>
      branch: v<% ctx().version.substring(0, ctx().version.lastIndexOf('.')) %>
      hosts: <% ctx().host %>
      cwd: <% ctx().cwd %>
  cleanup_on_failure:
    action: core.remote
    input:
      cmd: <% 'rm -rf ' + ctx().cwd + '/st2*' + ctx().local_repo_sfx %>
      hosts: <% ctx().host %>
    next:
      - do:
          - fail
