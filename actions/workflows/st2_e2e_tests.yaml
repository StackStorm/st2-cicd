---
version: '2.0'

st2cd.st2_e2e_tests:
    description: Run the suite of end to end tests on the st2 host
    type: direct
    input:
        - host_ip
        - host_fqdn
        - protocol
        - st2_username
        - st2_password
        - windows_host_ip
        - windows_host_fqdn
        - windows_username
        - windows_password
        - version
        - enterprise
    vars:
        retry_pabot_docs_tests_iteration_count: 0
        retry_pabot_chatops_CLI_tests_iteration_count: 0
    tasks:
        init:
            action: std.noop
            publish:
                st2_cli_env:
                    ST2_BASE_URL: <% $.protocol %>://<% $.host_fqdn %>
                    ST2_AUTH_URL: <% $.protocol %>://<% $.host_fqdn %>:9100
                    ST2_API_URL: <% $.protocol %>://<% $.host_fqdn %>:9101
            on-success:
                - get_st2_token
        get_st2_token:
            action: st2cd.get_st2_token
            input:
                hosts: <% $.host_ip %>
                env: <% $.st2_cli_env %>
                st2_username: <% $.st2_username %>
                st2_password: <% $.st2_password %>
            publish:
                st2_cli_env: <% $.st2_cli_env.set(
                                    ST2_AUTH_TOKEN,
                                    task(get_st2_token).result.get($.host_ip).stdout.get(token)) %>
            on-success:
                - setup_e2e_tests
        setup_e2e_tests:
            action: st2cd.setup_e2e_tests
            input:
                hosts: <% $.host_ip %>
                env: <% $.st2_cli_env %>
                version: <% $.version %>
                timeout: 220
            on-success:
                # Run Basic and quickstart tests together
                - run_basic_tests
                - run_quickstart_tests
        run_basic_tests:
            action: st2cd.st2_e2e_tests_test_basic
            input:
                host: <% $.host_ip %>
                env: <% $.st2_cli_env %>
            # on-success:
            #     - run_quickstart_tests
        run_quickstart_tests:
            action: st2cd.st2_e2e_tests_test_quickstart
            input:
                host: <% $.host_ip %>
                env: <% $.st2_cli_env %>
                protocol: <% $.protocol %>
            on-success:
                # Run Mistral tests after basic and quickstart
                - run_mistral_tests
        run_mistral_tests:
            action: st2cd.st2_e2e_tests_test_mistral
            input:
                host_fqdn: <% $.host_ip %>
                env: <% $.st2_cli_env %>
            on-success:
                - run_inquiry_tests
        run_inquiry_tests:
            action: st2cd.st2_e2e_tests_test_inquiry
            input:
                host: <% $.host_ip %>
                env: <% $.st2_cli_env %>
                protocol: <% $.protocol %>
            on-success:
                - run_windows_tests
        run_windows_tests:
            action: st2cd.st2_e2e_tests_test_windows
            input:
                host: <% $.host_ip %>
                windows_host: <% $.windows_host_ip %>
                windows_username: <% $.windows_username %>
                windows_password: <% $.windows_password %>
                env: <% $.st2_cli_env %>
                protocol: <% $.protocol %>
            on-success:
                - enterprise_tests: <% $.enterprise %>
        enterprise_tests:
           action: st2cd.st2_enterprise_tests
           input:
                host_ip: <% $.host_ip %>
