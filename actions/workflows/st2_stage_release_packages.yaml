version: '2.0'

st2cd.st2_stage_release_packages:
    description: Stage st2 packages for release.
    type: direct
    input:
        - version
        - projects
        - wait
        - distros:
            RHEL6: el6
            RHEL7: el7
            UBUNTU14: u14
            UBUNTU16: u16
            UBUNTU18: u18
    tasks:
        init:
            action: core.local
            input:
                cmd: "echo <% $.version %> | cut -d \".\" -f1-2"
            publish:
                branch: v<% task(init).result.stdout %>  # TODO: Convert to result()
            on-success:
                - package_all
        package_all:
            with-items: project in <% $.projects %>
            action: circle_ci.run_build
            input:
                project: stackstorm/<% $.project %>  # TODO: Convert to item()
                branch: <% $.branch %>  # TODO: Convert to ctx()
            publish:
                package_jobs: <% task(package_all).result.select(
                                [$.result.reponame, $.result.build_num]) %>  # TODO: Convert to ctx()
            on-success:
                - wait_for_packages: <% $.wait %>  # TODO: Convert to ctx()
        wait_for_packages:
            with-items: package_job in <% $.package_jobs %>  # TODO: Convert to ctx()
            action: st2cd.wait_for_package
            input:
                project: stackstorm/<% $.package_job[0] %>  # TODO: Convert to item()
                build_number: <% str($.package_job[1]) %>  # TODO: Convert to item()
